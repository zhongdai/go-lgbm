<!--
Sync Impact Report
===================
Version change: 0.0.0 (template) → 1.0.0 (initial ratification)
Modified principles: N/A (first ratification)
Added sections:
  - Core Principles (5): Leaves Compatibility, Pure Go / No CGo,
    LightGBM 3+4 Only, Test-First, Idiomatic Go API
  - Technical Constraints
  - Development Workflow
  - Governance
Removed sections: None
Templates requiring updates:
  - .specify/templates/plan-template.md        — ✅ no changes needed
  - .specify/templates/spec-template.md         — ✅ no changes needed
  - .specify/templates/tasks-template.md        — ✅ no changes needed
Follow-up TODOs: None
-->

# go-lgbm Constitution

## Core Principles

### I. Leaves Compatibility

go-lgbm MUST provide a migration path from
`github.com/dmitryikh/leaves`. Specifically:

- The library MUST load any LightGBM model file that `leaves` can
  load today (text format, v3 and v4).
- Public prediction APIs MUST accept the same input shapes (dense
  feature vectors) and produce numerically equivalent outputs within
  floating-point tolerance (1e-6 relative error).
- Package import paths and type names MAY differ, but a mechanical
  migration guide MUST be maintained in `docs/migration-from-leaves.md`.

**Rationale**: The sole reason this library exists is to replace
`leaves` with modern LightGBM support. If users cannot switch
painlessly, adoption fails.

### II. Pure Go / No CGo

All model loading and inference MUST be implemented in pure Go.
CGo MUST NOT be used anywhere in the library or its dependencies.

- No `import "C"` directives.
- No linkage to `lib_lightgbm.so` or any native LightGBM library.
- All tree traversal, objective functions, and transformations MUST
  be re-implemented in Go.

**Rationale**: CGo introduces build complexity, cross-compilation
pain, and deployment friction. A pure-Go library is `go get`-able
on any platform with zero system dependencies.

### III. LightGBM 3 and 4 Only

The library MUST support model files produced by LightGBM v3.x and
v4.x. Support for LightGBM v2.x or earlier is explicitly out of
scope and MUST NOT be added.

- The model parser MUST detect the LightGBM version from the model
  file header and reject unsupported versions with a clear error.
- When LightGBM v3 and v4 model formats diverge, both code paths
  MUST be tested independently.

**Rationale**: Scoping to v3+v4 keeps the codebase focused. The
`leaves` library already covers older versions for anyone who needs
them.

### IV. Test-First (NON-NEGOTIABLE)

Every feature MUST follow the Red-Green-Refactor cycle:

1. Write a failing test that captures the expected behavior.
2. Implement the minimum code to make the test pass.
3. Refactor while keeping tests green.

Additional requirements:

- Prediction accuracy tests MUST compare against reference outputs
  generated by the official LightGBM Python library.
- Golden-file tests MUST cover at least: binary classification,
  multiclass, regression, and ranking models for both v3 and v4.
- Test coverage MUST remain at or above 80%.

**Rationale**: Model inference bugs are silent and catastrophic.
Tests against known-good outputs are the primary correctness
guarantee.

### V. Idiomatic Go API

The public API MUST follow Go conventions and standard library
patterns:

- Exported names MUST follow effective Go naming (e.g.,
  `Model`, `Predict`, not `LGBMModel`, `LGBMPredict`).
- Errors MUST be returned as `error` values, never panics.
- The library MUST be safe for concurrent use: a loaded `Model`
  MUST support concurrent `Predict` calls without locking.
- All public types and functions MUST have godoc comments.
- Zero-value types MUST be usable or clearly documented otherwise.

**Rationale**: An idiomatic API lowers the learning curve and
integrates naturally with the broader Go ecosystem.

## Technical Constraints

- **Go version**: MUST target Go 1.21+ (generics available).
- **Dependencies**: MUST minimize external dependencies. Standard
  library preferred. Any third-party dependency MUST be justified
  in the PR that introduces it.
- **Allocations**: Prediction hot paths SHOULD minimize heap
  allocations. Benchmarks MUST be provided for `Predict` and
  compared against `leaves` performance.
- **Model formats**: MUST support LightGBM text model format.
  Binary (`.bin`) format support is optional and MAY be added
  later.
- **Immutability**: Loaded models MUST be immutable after
  construction. Prediction MUST NOT mutate model state.

## Development Workflow

- **Branching**: Feature branches off `main`; squash-merge PRs.
- **Commits**: Conventional commits (`feat:`, `fix:`, `test:`,
  `refactor:`, `docs:`, `chore:`, `perf:`).
- **Code review**: Every PR MUST be reviewed before merge.
- **CI checks**: `go vet`, `staticcheck`, `go test -race ./...`
  MUST pass on every PR.
- **Benchmarks**: Any change touching prediction code MUST include
  benchmark results (`go test -bench`) in the PR description.
- **Golden files**: Stored in `testdata/` and version-controlled.
  Regeneration requires running the Python reference script and
  MUST be documented.

## Governance

This constitution supersedes all other development practices for
the go-lgbm project. Amendments require:

1. A PR modifying this file with a clear rationale.
2. Approval from at least one project maintainer.
3. Version bump following semantic versioning:
   - MAJOR: Principle removed or fundamentally redefined.
   - MINOR: New principle or section added.
   - PATCH: Clarifications or wording fixes.
4. All dependent templates MUST be checked for consistency after
   any amendment (see Sync Impact Report at top of file).

All PRs and code reviews MUST verify compliance with the
principles above. Complexity that violates a principle MUST be
justified in writing and approved explicitly.

**Version**: 1.0.0 | **Ratified**: 2026-02-13 | **Last Amended**: 2026-02-13
